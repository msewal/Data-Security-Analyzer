{% extends "list/base_table.html" %}
{% load static %}

{% block title %}Tarama Raporu{% endblock %}

{% block table_title %}
    Virüs Tarama Raporu <small class="text-muted">(ID: {{ scan_id }})</small>
{% endblock %}

{% block content %}
{{ block.super }}

<div class="container mt-4">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> Genel Rapor Bilgileri</h5>
        </div>
        <div class="card-body">
            <p><strong>Rapor ID:</strong> {{ scan_id }}</p>
            <p><strong>Tarama Başlangıç Zamanı:</strong> {{ scan_start_time }}</p>
            <p><strong>Tarama Bitiş Zamanı:</strong> {{ scan_end_time }}</p>
            <p><strong>Tarama Süresi:</strong> {{ scan_duration }} saniye</p>
            <p><strong>Tarayan Kullanıcı:</strong> {% if request.user.is_authenticated %}{{ request.user.username }}{% else %}Misafir{% endif %}</p>
            <p><strong>Tarama Profili:</strong> {% if '/' in scan_target_path or '\\' in scan_target_path and not scan_target_path|slice:'-1' == '/' and not scan_target_path|slice:'-1' == '\\' %}Tek Dosya Tarama{% else %}Tam Klasör Tarama{% endif %}</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-folder"></i> Tarama Hedefleri</h5>
        </div>
        <div class="card-body">
            <p><strong>Hedef Konum:</strong> {{ scan_target_path }}</p>
            <p><strong>Taranan Toplam Dosya Sayısı:</strong> {{ total_files_scanned }}</p>
            <p><strong>Taranan Toplam Boyut:</strong> {{ total_scanned_size }}</p>
        </div>
    </div>

    {% if infected_files %}
    <div class="card mt-4 mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Tespit Edilen Tehditler ({{ infected_files|length }} Adet)</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Dosya Adı</th>
                            <th>Dosya Yolu</th>
                            <th>Boyut</th>
                            <th>Tür</th>
                            <th>Tehdit İsmi</th>
                            <th>Tehdit Seviyesi</th>
                            <th>Tespit Yöntemi</th>
                            <th>Hash (MD5)</th>
                            <th>Önerilen Eylem</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in infected_files %}
                        <tr>
                            <td>{{ file.name }}</td>
                            <td>{{ file.path }}</td>
                            <td>{{ file.file_size }}</td>
                            <td>{{ file.file_type }}</td>
                            <td>{{ file.malware_type }}</td>
                            <td><span class="badge bg-danger">{{ file.threat_level }}</span></td>
                            <td>{{ file.scan_method }}</td>
                            <td><code>{{ file.hash }}</code></td>
                            <td>{{ file.recommended_action }}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="quarantineFile('{{ file.path|escapejs }}')">
                                    <i class="bi bi-archive"></i> Karantinaya Al
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-success mt-4" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i> Tarama tamamlandı. Herhangi bir tehdit bulunamadı.
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up"></i> İstatistiksel Özet</h5>
        </div>
        <div class="card-body">
            <p><strong>Toplam Tespit Sayısı:</strong> {{ infected_files|length }}</p>
            <p><strong>Toplam Temiz Dosya Sayısı:</strong> {{ total_clean_files }}</p>
            <p><strong>Toplam Karantinaya Alınan Dosya Sayısı:</strong> Henüz eklenmedi</p>
            <p><strong>Yanlış Pozitif (False Positive) Oranı:</strong> Hesaplamak için daha fazla veri gerekiyor</p>
            <p><strong>Tespit Edilen Malware Türlerinin Dağılımı:</strong> (Grafik daha sonra eklenecek)</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0"><i class="bi bi-archive"></i> Karantina Bilgileri</h5>
        </div>
        <div class="card-body">
            <p>Karantinaya alınan dosyaların detayları <a href="{% url 'malware:quarantine_list' %}">Karantina Listesi</a> sayfasında görüntülenebilir.</p>
            <p><strong>Yeni Saklama Yolu:</strong> Sistem tarafından otomatik belirlenir</p>
            <p><strong>Karantina Nedeni:</strong> Virüs Tespiti</p>
            <p><strong>Erişim Yetkileri:</strong> Genellikle salt okunur ve sistem tarafından şifrelenmiş</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-journal-text"></i> Uyum ve Log Kaydı</h5>
        </div>
        <div class="card-body">
            <p>Tüm tarama ve karantina olayları arka planda sistem loglarına kaydedilmektedir.</p>
            <ul>
                <li>**Zaman Damgası:** Her işlem için mevcuttur.</li>
                <li>**İşlemi Yapan Kullanıcı/Sistem Servisi:** Mevcuttur.</li>
                <li>**İşlemin Sonucu:** Mevcuttur (başarılı/başarısız).</li>
            </ul>
            <p>Ham çıktı (JSON/LOG formatı) için sistem yöneticisi log dosyalarını inceleyebilir.</p>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-shield-check"></i> Önerilen Önlemler</h5>
        </div>
        <div class="card-body">
            <ul>
                <li>Tespit edilen tehditleri en kısa sürede karantinaya alın veya silin.</li>
                <li>İşletim sisteminizi ve tüm yazılımlarınızı güncel tutun.</li>
                <li>Periyodik olarak tam sistem taramaları yapın.</li>
                <li>Güçlü ve benzersiz parolalar kullanın.</li>
                <li>Güvenilmeyen kaynaklardan dosya indirmekten kaçının.</li>
                <li>Kritik verilerinizin düzenli yedeklerini alın.</li>
                <li>Şüpheli e-postaları veya bağlantıları açmadan önce iki kez kontrol edin.</li>
                <li>Eğer tekrarlayan tehditler varsa, ağ trafiği analizi ve güvenlik duvarı yapılandırmasını gözden geçirin.</li>
            </ul>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function quarantineFile(filePath) {
        if (!confirm('Bu dosyayı karantinaya almak istediğinizden emin misiniz?')) {
            return;
        }

        fetch('{% url "malware:api_quarantine" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                file_path: filePath
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Dosya başarıyla karantinaya alındı.');
                location.reload(); // Reload to reflect changes or update UI dynamically
            } else {
                alert('Dosya karantinaya alınırken bir hata oluştu: ' + data.error);
            }
        })
        .catch(error => {
            alert('Dosya karantinaya alınırken bir hata oluştu: ' + error);
        });
    }
</script>
{% endblock %} 