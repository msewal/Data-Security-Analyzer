{% extends "list/base_table.html" %}
{% load static %}

{% block title %}Virüs Tarama{% endblock %}

{% block table_title %}
    Virüs Tarama
    {% if current_path %}
        <small class="text-muted">({{ current_path }})</small>
    {% endif %}
{% endblock %}

{% block table_headers %}
<th></th> {# For folder/file icon #}
<th>Ad</th>
<th>Tür</th>
<th>Boyut</th>
<th>İzinler</th>
<th>Sahip</th>
<th>Grup</th>
<th>Değiştirilme Tarihi</th>
<th>İşlemler</th>
{% endblock %}

{% block table_actions %}
<div class="btn-group">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#scanModal">
        <i class="fas fa-search"></i> Tarama Başlat
    </button>
</div>
{% endblock %}

{% block table_content %}
{% if error %}
<tr>
    <td colspan="11" class="text-danger">{{ error }}</td>
</tr>
{% else %}
    {# Navigation: Go up a directory #}
    {% if parent_path is not None %}
    <tr>
        <td><i class="bi bi-folder"></i></td>
        <td><a href="{% url 'malware:malware_scan' %}?path={{ parent_path }}">...</a></td>
        <td>Klasör</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>
            <button class="btn btn-sm btn-primary scan-folder" data-path="{{ parent_path }}">
                <i class="fas fa-search"></i> Tara
            </button>
        </td>
    </tr>
    {% endif %}

    {# List files and directories #}
        {% for item in items %}
        <tr>
            <td>
                {% if item.is_dir %}
            <i class="fas fa-folder text-warning"></i>
            <a href="?path={{ item.path|urlencode }}">{{ item.name }}</a>
                {% else %}
            <i class="fas fa-file text-primary"></i>
                    {{ item.name }}
                {% endif %}
            </td>
            <td>{{ item.file_type_display }}</td>
            <td>{{ item.size }}</td>
            <td>{{ item.permissions }}</td>
            <td>{{ item.owner }}</td>
            <td>{{ item.group }}</td>
            <td>{{ item.modified }}</td>
            <td>
            {% if item.is_dir %}
            <button class="btn btn-sm btn-primary scan-folder" data-path="{{ item.path }}">
                <i class="fas fa-search"></i> Tara
                </button>
                {% else %}
            <button class="btn btn-sm btn-primary scan-file" data-path="{{ item.path }}">
                <i class="fas fa-search"></i> Tara
                </button>
                {% endif %}
            </td>
        </tr>
    {% empty %}
        <tr>
        <td colspan="11" class="text-center">Klasör boş veya içeriği listelenemedi.</td>
        </tr>
    {% endfor %}
    {% endif %}
{% endblock %}

{% block content %}
{{ block.super }}

{# Scan Results Section #}
<div id="scanResultsSection">
    {% if infected_files %}
    <div class="card mt-4">
        <div class="card-header bg-danger text-white">
            <i class="bi bi-exclamation-triangle"></i> Tespit Edilen Tehditler
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Dosya Yolu</th>
                            <th>Tehdit Türü</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in infected_files %}
                        <tr>
                            <td>{{ file.path }}</td>
                            <td>{{ file.malware_type }}</td>
                            <td>
                                <button class="btn btn-sm btn-warning" onclick="quarantineFile('{{ file.path|escapejs }}')">
                                    <i class="bi bi-archive"></i> Karantinaya Al
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
<!-- Tarama Modal -->
<div class="modal fade" id="scanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Malware Tarama</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="scanForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="modalScanTargetPath" class="form-label">Tarama Hedefi</label>
                        <input type="text" class="form-control" id="modalScanTargetPath" name="scan_target_path" value="{{ current_path }}">
                    </div>
                    <div class="mb-3 form-check">
                        <input class="form-check-input" type="checkbox" id="modalScanArchives" name="scan_archives">
                        <label class="form-check-label" for="modalScanArchives">
                            Arşivleri Tara
                        </label>
                    </div>
                </form>
                <div id="scanProgressContainer" class="mt-3 d-none">
                    <div class="progress">
                        <div id="scanProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                    <p id="scanProgressText" class="mt-2 text-muted"></p>
                    <p id="currentFileText" class="mt-1 text-muted"></p>
                </div>
                <div id="scanResultDisplay" class="mt-3">
                    <!-- Scan results will be loaded here dynamically -->
                </div>
                <div id="viewReportButtonContainer" class="mt-3 text-center d-none">
                    <a href="#" id="viewReportButton" class="btn btn-success"><i class="bi bi-file-earmark-bar-graph"></i> Raporu Görüntüle</a>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-primary" id="startScanButton">Tarama Başlat</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener("DOMContentLoaded", function() {
        const scanModalElement = document.getElementById('scanModal');
        let scanModal;
        if (scanModalElement) {
            scanModal = new bootstrap.Modal(scanModalElement);
        }

        const startScanButton = document.getElementById('startScanButton');
        const modalScanTargetPath = document.getElementById('modalScanTargetPath');
        const modalScanArchives = document.getElementById('modalScanArchives');
        const scanProgressContainer = document.getElementById('scanProgressContainer');
        const scanProgressBar = document.getElementById('scanProgressBar');
        const scanProgressText = document.getElementById('scanProgressText');
        const currentFileText = document.getElementById('currentFileText');
        const scanResultDisplay = document.getElementById('scanResultDisplay');
        const viewReportButtonContainer = document.getElementById('viewReportButtonContainer');
        const viewReportButton = document.getElementById('viewReportButton');
        let scanInterval;
        let currentScanId = null; // To store the current scan ID

        // Handle opening the modal from the "Tarama Başlat" button in table_actions
        document.querySelector('button[data-bs-target="#scanModal"]').addEventListener('click', function() {
            modalScanTargetPath.value = '{{ current_path }}'; // Default to current directory
            modalScanArchives.checked = false; // Default to not scan archives
            scanProgressContainer.classList.add('d-none'); // Hide progress
            scanResultDisplay.innerHTML = ''; // Clear previous results
            startScanButton.disabled = false; // Enable start button
            startScanButton.textContent = 'Tarama Başlat'; // Reset button text
            viewReportButtonContainer.classList.add('d-none'); // Hide report button
            currentScanId = null; // Reset scan ID
        });

        // Handle opening the modal from individual file/folder scan buttons
        document.querySelectorAll('.scan-file, .scan-folder').forEach(button => {
            button.addEventListener('click', function() {
                modalScanTargetPath.value = this.dataset.path;
                modalScanArchives.checked = false; // Default for single file/folder scan
                scanProgressContainer.classList.add('d-none'); // Hide progress
                scanResultDisplay.innerHTML = ''; // Clear previous results
                startScanButton.disabled = false; // Enable start button
                startScanButton.textContent = 'Tarama Başlat'; // Reset button text
                viewReportButtonContainer.classList.add('d-none'); // Hide report button
                currentScanId = null; // Reset scan ID
                if (scanModal) { // Check if scanModal is defined before showing
                    scanModal.show();
                }
            });
        });

        if (startScanButton) {
            startScanButton.addEventListener('click', function() {
    startScan();
            });
}

function startScan() {
            const path = modalScanTargetPath.value;
            const scanArchives = modalScanArchives.checked;

            if (!path) {
                alert('Lütfen taranacak dosya veya dizin yolunu belirtin.');
                return;
            }

            startScanButton.disabled = true;
            startScanButton.textContent = 'Tarama Başlatılıyor...';
            scanProgressContainer.classList.remove('d-none');
            scanResultDisplay.innerHTML = '';
            viewReportButtonContainer.classList.add('d-none'); // Ensure hidden at start

            fetch('{% url "malware:api_malware_scan" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    scan_target_path: path,
                    scan_archives: scanArchives
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentScanId = data.scan_id; // Store scan ID
                    startScanButton.textContent = 'Tarama Devam Ediyor...';
                    startProgressCheck(currentScanId);
                } else {
                    handleScanError(data.error || 'Tarama başlatılamadı.');
                }
            })
            .catch(error => {
                handleScanError('Tarama başlatılırken bir hata oluştu: ' + error);
            });
        }

        function startProgressCheck(scanId) {
            if (scanInterval) {
                clearInterval(scanInterval);
            }

            scanInterval = setInterval(() => {
                fetch(`{% url 'malware:scan_status' %}?scan_id=${scanId}`)
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(data);
                        if (data.status === 'completed' || data.status === 'error') {
                            clearInterval(scanInterval);
                            handleScanComplete(data);
                        }
                    })
                    .catch(error => {
                        clearInterval(scanInterval);
                        handleScanError('Tarama durumu kontrol edilirken bir hata oluştu: ' + error);
                    });
            }, 1000);
        }

        function updateProgress(data) {
            if (data.progress) {
                scanProgressBar.style.width = `${data.progress}%`;
                scanProgressBar.setAttribute('aria-valuenow', data.progress);
                scanProgressBar.textContent = `${data.progress}%`;
            }
            if (data.current_file) {
                currentFileText.textContent = `Taranan Dosya: ${data.current_file}`;
            }
            if (data.status_message) {
                scanProgressText.textContent = data.status_message;
            }
        }

        function handleScanComplete(data) {
            startScanButton.disabled = false;
            startScanButton.textContent = 'Tarama Başlat';

            if (data.status === 'completed') {
                if (data.infected_files && data.infected_files.length > 0) {
                    displayScanResults(data.infected_files);
                } else {
                    scanResultDisplay.innerHTML = '<div class="alert alert-success">Tarama tamamlandı. Tehdit bulunamadı.</div>';
                }
                if (currentScanId) {
                    viewReportButton.href = `{% url "malware:malware_scan_results" %}?scan_id=${currentScanId}`;
                    viewReportButtonContainer.classList.remove('d-none');
                }
    } else {
                handleScanError(data.error || 'Tarama sırasında bir hata oluştu.');
            }
        }

        function handleScanError(error) {
            startScanButton.disabled = false;
            startScanButton.textContent = 'Tarama Başlat';
            scanResultDisplay.innerHTML = `<div class="alert alert-danger">${error}</div>`;
            viewReportButtonContainer.classList.add('d-none'); // Hide report button on error
        }

        function displayScanResults(infectedFiles) {
            let html = '<div class="alert alert-danger">';
            html += '<h5><i class="bi bi-exclamation-triangle"></i> Tespit Edilen Tehditler</h5>';
            html += '<div class="table-responsive"><table class="table table-sm">';
            html += '<thead><tr><th>Dosya</th><th>Tehdit</th><th>İşlem</th></tr></thead><tbody>';
            
            infectedFiles.forEach(file => {
                html += `<tr>
                    <td>${file.path}</td>
                    <td>${file.malware_type || 'Bilinmeyen Tehdit'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="quarantineFile('${file.path}')">
                            <i class="bi bi-archive"></i> Karantinaya Al
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div></div>';
            scanResultDisplay.innerHTML = html;
        }

        function quarantineFile(filePath) {
            if (!confirm('Bu dosyayı karantinaya almak istediğinizden emin misiniz?')) {
                return;
            }

            fetch('{% url "malware:api_quarantine" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    file_path: filePath
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Dosya başarıyla karantinaya alındı.');
                    location.reload();
                } else {
                    alert('Dosya karantinaya alınırken bir hata oluştu: ' + data.error);
                }
            })
            .catch(error => {
                alert('Dosya karantinaya alınırken bir hata oluştu: ' + error);
            });
        }
    }); // End DOMContentLoaded
</script>
{% endblock %} 