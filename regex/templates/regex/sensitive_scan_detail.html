{% extends 'list/base.html' %}
{% load static %}

{% block title %}Hassas Veri Taraması Detayları{% endblock %}

{% block extra_css %}
<style>
    .detail-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .category-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    .category-header {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 3px;
        margin-bottom: 10px;
    }
    .subcategory-section {
        margin-left: 20px;
        margin-bottom: 15px;
    }
    .match-list {
        list-style: none;
        padding-left: 0;
    }
    .match-item {
        padding: 5px;
        margin: 2px 0;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 3px;
    }
    .back-button {
        margin-bottom: 20px;
    }
    .action-buttons {
        margin-top: 20px;
        padding: 15px;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    .quarantine-button {
        background-color: #dc3545;
        color: white;
    }
    .quarantine-button:hover {
        background-color: #c82333;
        color: white;
    }
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }
    .match-item {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .match-header {
        margin-bottom: 10px;
    }
    .match-content {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }
    .match-details {
        margin-top: 10px;
    }
    pre {
        margin: 0;
        white-space: pre-wrap;
    }
    code {
        color: #e83e8c;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">
        <i class="bi bi-file-earmark-text"></i> Dosya Detayları
    </h2>

    {% if error_message %}
    <div class="alert alert-danger">
        {{ error_message }}
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Dosya Bilgileri</h5>
        </div>
        <div class="card-body">
            <p><strong>Dosya Yolu:</strong> {{ file_path }}</p>
            <button class="btn btn-danger" onclick="quarantineFile()">
                <i class="bi bi-shield-lock"></i> Dosyayı Karantinaya Al
            </button>
        </div>
    </div>

    {% if matches %}
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Bulunan Eşleşmeler</h5>
        </div>
        <div class="card-body">
            {% for match in matches %}
            <div class="match-item mb-4">
                <div class="match-header">
                    <h6>
                        <span class="badge bg-primary">{{ match.category }}</span>
                        <span class="badge bg-secondary">{{ match.subcategory }}</span>
                        <small class="text-muted">Satır {{ match.line }}</small>
                    </h6>
                </div>
                <div class="match-content">
                    <pre class="bg-light p-3 rounded"><code>{{ match.context }}</code></pre>
                    <div class="match-details">
                        <p><strong>Eşleşme:</strong> <code>{{ match.match }}</code></p>
                        <p><strong>Desen:</strong> <code>{{ match.pattern }}</code></p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="alert alert-info">
        Bu dosyada hassas veri eşleşmesi bulunamadı.
    </div>
    {% endif %}
</div>

<div class="toast-container">
    <div id="quarantineToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Karantina İşlemi</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    async function quarantineFile() {
        if (!confirm('Bu dosyayı karantinaya almak istediğinizden emin misiniz?')) {
            return;
        }

        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            // Form verisi oluştur
            const formData = new FormData();
            formData.append('file_path', '{{ file_path|escapejs }}');
            formData.append('threat_type', 'Sensitive Data');
            formData.append('threat_level', 'High');
            formData.append('detected_pattern', '{{ matches|first|first|escapejs }}');

            console.log('Gönderilen veri:', Object.fromEntries(formData));

            const response = await fetch('{{ quarantine_url|safe }}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                alert('Dosya başarıyla karantinaya alındı.');
                window.location.href = '{% url "regex:sensitive_scan" %}';
            } else {
                alert('Hata: ' + data.error);
            }
        } catch (error) {
            console.error('Karantina hatası:', error);
            alert('Dosya karantinaya alınırken bir hata oluştu.');
        }
    }
</script>
{% endblock %} 