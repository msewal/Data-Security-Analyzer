{% extends 'list/base.html' %}
{% load static %}

{% block title %}Hassas Veri Taraması Detayları - {{ file_path }}{% endblock %}

{% block extra_css %}
<style>
    .detail-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .file-content {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 20px;
        max-height: 600px;
        overflow-y: auto;
        font-family: 'Courier New', Courier, monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.5;
    }
    .highlighted-match {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
        padding: 2px 4px;
        border-radius: 3px;
        text-decoration: line-through;
        text-decoration-color: #dc3545;
        text-decoration-thickness: 2px;
    }
    .category-section {
        margin-bottom: 20px;
        padding: 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    .category-header {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 3px;
        margin-bottom: 10px;
    }
    .match-item {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
        background-color: #fff;
    }
    .match-header {
        margin-bottom: 10px;
    }
    .match-content {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
    }
    .file-info-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    .file-stats {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .nav-tabs .nav-link.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    .line-numbers {
        color: #6c757d;
        user-select: none;
        margin-right: 15px;
    }
    .content-line {
        display: flex;
        margin-bottom: 2px;
    }
    .content-text {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'list:index' %}">Ana Sayfa</a></li>
            <li class="breadcrumb-item"><a href="{% url 'regex:sensitive_scan' %}">Hassas Veri Taraması</a></li>
            <li class="breadcrumb-item"><a href="{% url 'regex:sensitive_scan_results' %}">Sonuçlar</a></li>
            <li class="breadcrumb-item active">Detay</li>
        </ol>
    </nav>

    <h2 class="mb-4">
        <i class="bi bi-file-earmark-text"></i> Dosya Detay Analizi
    </h2>

    {% if error_message %}
    <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> {{ error_message }}
    </div>
    {% endif %}

    <!-- Dosya Bilgileri -->
    <div class="card file-info-card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <h5 class="card-title mb-3">
                        <i class="bi bi-file-earmark"></i> {{ file_path|slice:"-20:" }}
                    </h5>
                    <p class="mb-2"><strong>Tam Yol:</strong> {{ file_path }}</p>
                    <p class="mb-2"><strong>Dosya Türü:</strong> {{ file_type|default:"Bilinmiyor" }}</p>
                    <p class="mb-0"><strong>Boyut:</strong> {{ file_size|default:"Bilinmiyor" }}</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group-vertical">
                        <a href="{% url 'regex:view_file' file_path %}" class="btn btn-light btn-sm mb-2">
                            <i class="bi bi-eye"></i> Dosyayı Görüntüle
                        </a>
                        <a href="{% url 'regex:edit_file' file_path %}" class="btn btn-light btn-sm mb-2">
                            <i class="bi bi-pencil"></i> Düzenle
                        </a>
                        <button class="btn btn-danger btn-sm" onclick="quarantineFile()">
                            <i class="bi bi-shield-lock"></i> Karantinaya Al
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- İstatistikler -->
    {% if matches %}
    <div class="file-stats">
        <div class="row text-center">
            <div class="col-md-2">
                <h5 class="text-primary">{{ matches|length }}</h5>
                <small class="text-muted">Toplam Eşleşme</small>
            </div>
            <div class="col-md-2">
                <h5 class="text-success">{{ unique_categories|length }}</h5>
                <small class="text-muted">Kategori</small>
            </div>
            <div class="col-md-2">
                <h5 class="text-warning">{{ unique_subcategories|length }}</h5>
                <small class="text-muted">Alt Kategori</small>
            </div>
            <div class="col-md-2">
                <h5 class="text-info">{{ unique_patterns|length }}</h5>
                <small class="text-muted">Benzersiz Desen</small>
            </div>
            <div class="col-md-2">
                <h5 class="text-secondary">{{ extraction_method|title }}</h5>
                <small class="text-muted">Çıkarım Metodu</small>
            </div>
            {% if file_metadata.page_count %}
            <div class="col-md-2">
                <h5 class="text-dark">{{ file_metadata.page_count }}</h5>
                <small class="text-muted">Sayfa Sayısı</small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="detailTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="content-tab" data-bs-toggle="tab" data-bs-target="#content" type="button" role="tab">
                <i class="bi bi-file-text"></i> Dosya İçeriği
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="matches-tab" data-bs-toggle="tab" data-bs-target="#matches" type="button" role="tab">
                <i class="bi bi-search"></i> Eşleşmeler ({{ matches|length }})
            </button>
        </li>
        {% if file_metadata %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="metadata-tab" data-bs-toggle="tab" data-bs-target="#metadata" type="button" role="tab">
                <i class="bi bi-info-circle"></i> Meta Veriler
            </button>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                <i class="bi bi-shield-lock"></i> Güvenlik İşlemleri
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="detailTabsContent">
        <!-- Dosya İçeriği -->
        <div class="tab-pane fade show active" id="content" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Dosya İçeriği (Eşleşmeler Vurgulanmış)</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" onclick="toggleLineNumbers()">
                            <i class="bi bi-list-ol"></i> Satır No
                        </button>
                        <button class="btn btn-outline-secondary" onclick="downloadFile()">
                            <i class="bi bi-download"></i> İndir
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="file-content" id="fileContent">
                        {% if file_content %}
                            {% for line in file_content_lines %}
                            <div class="content-line">
                                <span class="line-numbers" style="display: none;">{{ forloop.counter }}:</span>
                                <span class="content-text">{{ line|safe }}</span>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-muted p-3">Dosya içeriği görüntülenemiyor.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Eşleşmeler -->
        <div class="tab-pane fade" id="matches" role="tabpanel">
            {% if matches %}
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Bulunan Hassas Veriler</h6>
                </div>
                <div class="card-body">
                    {% for match in matches %}
                    <div class="match-item">
                        <div class="match-header">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-1">
                                        <span class="badge bg-primary">{{ match.category }}</span>
                                        <span class="badge bg-secondary">{{ match.subcategory }}</span>
                                        <small class="text-muted ms-2">Satır {{ match.line }}</small>
                                    </h6>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-sm btn-outline-primary" onclick="goToLine({{ match.line }})">
                                        <i class="bi bi-arrow-right"></i> Satıra Git
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="match-content">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Bulunan Değer:</h6>
                                    <code class="bg-warning p-2 rounded d-block">{{ match.match }}</code>
                                </div>
                                <div class="col-md-6">
                                    <h6>Kullanılan Desen:</h6>
                                    <code class="bg-info p-2 rounded d-block text-white">{{ match.pattern }}</code>
                                </div>
                            </div>
                            <div class="mt-3">
                                <h6>Bağlam:</h6>
                                <pre class="bg-light p-3 rounded"><code>{{ match.context }}</code></pre>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Bu dosyada hassas veri eşleşmesi bulunamadı.
            </div>
            {% endif %}
        </div>

        <!-- Meta Veriler -->
        {% if file_metadata %}
        <div class="tab-pane fade" id="metadata" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Dosya Meta Verileri</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for key, value in file_metadata.items %}
                        <div class="col-md-6 mb-3">
                            <strong>{{ key|title }}:</strong>
                            <span class="text-muted">{{ value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if page_data %}
                    <hr>
                    <h6>Sayfa Detayları:</h6>
                    <div class="accordion" id="pageAccordion">
                        {% for page in page_data %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#page-{{ forloop.counter }}">
                                    Sayfa {{ page.page_number }} ({{ page.char_count }} karakter)
                                </button>
                            </h2>
                            <div id="page-{{ forloop.counter }}" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">{{ page.text }}</pre>
                                    {% if page.tables %}
                                    <h6 class="mt-3">Tablolar:</h6>
                                    {% for table in page.tables %}
                                    <div class="table-responsive mb-3">
                                        <table class="table table-sm table-bordered">
                                            {% for row in table %}
                                            <tr>
                                                {% for cell in row %}
                                                <td>{{ cell }}</td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Güvenlik İşlemleri -->
        <div class="tab-pane fade" id="security" role="tabpanel">
            <div class="row">
                <!-- Maskeleme -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-eye-slash"></i> Veri Maskeleme</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Maskeleme Türü:</label>
                                <select class="form-select" id="maskType">
                                    <option value="asterisk">Yıldız (*) ile Maskele</option>
                                    <option value="partial">Kısmi Maskeleme</option>
                                    <option value="hash">Hash ile Maskele</option>
                                </select>
                            </div>
                            <button class="btn btn-warning" onclick="maskSensitiveData()">
                                <i class="bi bi-eye-slash"></i> Maskeleme Uygula
                            </button>
                            <div id="maskedContent" class="mt-3" style="display: none;">
                                <h6>Maskelenmiş İçerik:</h6>
                                <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                                    <pre id="maskedText"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Şifreleme -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-lock"></i> Veri Şifreleme</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Şifre:</label>
                                <input type="password" class="form-control" id="encryptPassword" placeholder="Güçlü bir şifre girin">
                            </div>
                            <div class="btn-group w-100 mb-3">
                                <button class="btn btn-success" onclick="encryptContent()">
                                    <i class="bi bi-lock"></i> Şifrele
                                </button>
                                <button class="btn btn-info" onclick="decryptContent()">
                                    <i class="bi bi-unlock"></i> Şifreyi Çöz
                                </button>
                            </div>
                            
                            <div id="encryptedContent" class="mt-3" style="display: none;">
                                <h6>Şifrelenmiş İçerik:</h6>
                                <textarea class="form-control" id="encryptedText" rows="6" readonly></textarea>
                                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="copyToClipboard('encryptedText')">
                                    <i class="bi bi-clipboard"></i> Kopyala
                                </button>
                            </div>
                            
                            <div id="decryptSection" class="mt-3">
                                <h6>Şifrelenmiş Veri Çözme:</h6>
                                <textarea class="form-control mb-2" id="decryptInput" rows="4" placeholder="Şifrelenmiş veriyi buraya yapıştırın"></textarea>
                                <div id="decryptedContent" style="display: none;">
                                    <h6>Çözülmüş İçerik:</h6>
                                    <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                                        <pre id="decryptedText"></pre>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Bildirimi -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="actionToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="bi bi-info-circle me-2"></i>
            <strong class="me-auto">Bildirim</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function toggleLineNumbers() {
        var lineNumbers = document.querySelectorAll('.line-numbers');
        var isVisible = lineNumbers[0].style.display !== 'none';
        
        for (var i = 0; i < lineNumbers.length; i++) {
            lineNumbers[i].style.display = isVisible ? 'none' : 'inline';
        }
    }

    function goToLine(lineNumber) {
        // İçerik sekmesine geç
        document.getElementById('content-tab').click();
        
        // Satıra scroll yap
        setTimeout(function() {
            var lines = document.querySelectorAll('.content-line');
            if (lines[lineNumber - 1]) {
                lines[lineNumber - 1].scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                lines[lineNumber - 1].style.backgroundColor = '#fff3cd';
                setTimeout(function() {
                    lines[lineNumber - 1].style.backgroundColor = '';
                }, 2000);
            }
        }, 100);
    }

    function downloadFile() {
        var filePath = '{{ file_path|escapejs }}';
        window.location.href = '/list/download?path=' + encodeURIComponent(filePath);
    }

    function quarantineFile() {
        if (!confirm('Bu dosyayı karantinaya almak istediğinizden emin misiniz?')) {
            return;
        }

        var filePath = '{{ file_path|escapejs }}';
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/regex/quarantine/' + encodeURIComponent(filePath) + '/', true);
        xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    try {
                        var data = JSON.parse(xhr.responseText);
                        if (data.success) {
                            showToast('Dosya başarıyla karantinaya alındı.', 'success');
                            setTimeout(function() {
                                window.location.href = '{% url "regex:sensitive_scan_results" %}';
                            }, 1500);
                        } else {
                            showToast('Hata: ' + (data.error || 'Bilinmeyen hata'), 'error');
                        }
                    } catch (e) {
                        showToast('Dosya başarıyla karantinaya alındı.', 'success');
                        setTimeout(function() {
                            window.location.href = '{% url "regex:sensitive_scan_results" %}';
                        }, 1500);
                    }
                } else {
                    showToast('Dosya karantinaya alınırken bir hata oluştu.', 'error');
                }
            }
        };
        
        xhr.send();
    }

    function showToast(message, type) {
        if (typeof type === 'undefined') {
            type = 'info';
        }
        var toast = document.getElementById('actionToast');
        var toastBody = toast.querySelector('.toast-body');
        var toastHeader = toast.querySelector('.toast-header');
        
        toastBody.textContent = message;
        
        // Renk ayarı
        var bgClass = 'toast-header bg-';
        if (type === 'success') {
            bgClass += 'success';
        } else if (type === 'error') {
            bgClass += 'danger';
        } else {
            bgClass += 'info';
        }
        bgClass += ' text-white';
        toastHeader.className = bgClass;
        
        var bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    // Maskeleme işlemi
    function maskSensitiveData() {
        var maskType = document.getElementById('maskType').value;
        var filePath = '{{ file_path|escapejs }}';
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        document.getElementById('maskedText').textContent = response.masked_content;
                        document.getElementById('maskedContent').style.display = 'block';
                        showToast('Maskeleme başarılı!', 'success');
                    } else {
                        showToast('Maskeleme hatası: ' + response.error, 'error');
                    }
                } catch (e) {
                    showToast('Maskeleme sırasında hata oluştu.', 'error');
                }
            }
        };
        
        xhr.send('action=mask&mask_type=' + encodeURIComponent(maskType));
    }

    // Şifreleme işlemi
    function encryptContent() {
        var password = document.getElementById('encryptPassword').value;
        if (!password) {
            showToast('Lütfen bir şifre girin.', 'error');
            return;
        }
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        document.getElementById('encryptedText').value = response.encrypted_content;
                        document.getElementById('encryptedContent').style.display = 'block';
                        showToast('Şifreleme başarılı!', 'success');
                    } else {
                        showToast('Şifreleme hatası: ' + response.error, 'error');
                    }
                } catch (e) {
                    showToast('Şifreleme sırasında hata oluştu.', 'error');
                }
            }
        };
        
        xhr.send('action=encrypt&password=' + encodeURIComponent(password));
    }

    // Şifre çözme işlemi
    function decryptContent() {
        var password = document.getElementById('encryptPassword').value;
        var encryptedData = document.getElementById('decryptInput').value;
        
        if (!password) {
            showToast('Lütfen bir şifre girin.', 'error');
            return;
        }
        
        if (!encryptedData) {
            showToast('Lütfen şifrelenmiş veriyi girin.', 'error');
            return;
        }
        
        var xhr = new XMLHttpRequest();
        xhr.open('POST', window.location.href, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader('X-CSRFToken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                try {
                    var response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        document.getElementById('decryptedText').textContent = response.decrypted_content;
                        document.getElementById('decryptedContent').style.display = 'block';
                        showToast('Şifre çözme başarılı!', 'success');
                    } else {
                        showToast('Şifre çözme hatası: ' + response.error, 'error');
                    }
                } catch (e) {
                    showToast('Şifre çözme sırasında hata oluştu.', 'error');
                }
            }
        };
        
        xhr.send('action=decrypt&password=' + encodeURIComponent(password) + '&encrypted_data=' + encodeURIComponent(encryptedData));
    }

    // Panoya kopyalama
    function copyToClipboard(elementId) {
        var element = document.getElementById(elementId);
        element.select();
        element.setSelectionRange(0, 99999);
        document.execCommand('copy');
        showToast('Panoya kopyalandı!', 'success');
    }

    // Sayfa yüklendiğinde eşleşmeleri vurgula
    document.addEventListener('DOMContentLoaded', function() {
        // Bu fonksiyon zaten sunucu tarafında yapılmış olmalı
    });
</script>
{% endblock %} 