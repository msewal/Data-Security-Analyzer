{% extends 'list/base.html' %}
{% load static %}

{% block title %}Hassas Veri Taraması Başlat{% endblock %}

{% block extra_css %}
<style>
    .scan-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .category-container {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
    }
    .category-header {
        cursor: pointer;
        padding: 5px;
        background-color: #e9ecef;
        border-radius: 3px;
        margin-bottom: 10px;
    }
    .subcategory-container {
        margin-left: 20px;
        display: none;
    }
    .subcategory-container.show {
        display: block;
    }
    .file-types-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
    }
    .select-all-container {
        margin-bottom: 10px;
    }
    .file-type-group {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .file-type-group:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .file-type-group h6 {
        color: #495057;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid #e9ecef;
    }
    .file-type-checkbox {
        cursor: pointer;
    }
    .file-type-label {
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: all 0.2s ease;
        display: inline-block;
        width: 100%;
    }
    .file-type-label:hover {
        background-color: #f8f9fa;
    }
    .file-type-checkbox:checked + .file-type-label {
        background-color: #e3f2fd;
        color: #0d6efd;
    }
    .file-type-description {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 2px;
        display: none;
    }
    .file-type-label:hover + .file-type-description {
        display: block;
    }
    .result-section {
        margin-top: 30px;
        border-top: 1px solid #e9ecef;
        padding-top: 20px;
    }
    .file-result-card {
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
    }
    .file-result-card .card-header {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        font-weight: bold;
    }
    .file-result-card .card-body {
        padding: 15px;
    }
    .match-item {
        background-color: #f0f8ff;
        border-left: 5px solid #007bff;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 5px;
    }
    .match-item strong {
        color: #0056b3;
    }
    .match-details {
        font-size: 0.9em;
        color: #555;
        margin-top: 5px;
    }
    .match-details pre {
        background-color: #e9ecef;
        padding: 5px;
        border-radius: 3px;
        white-space: pre-wrap;
        word-break: break-all;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">
        <i class="bi bi-shield-check"></i> Hassas Veri Taraması Başlat
    </h2>
    <div class="scan-container">
        <form method="post" action="{% url 'regex:sensitive_scan' %}" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="directory" class="form-label">Arama Yapılacak Dizin</label>
                    <input type="text" class="form-control" id="directory" name="directory" placeholder="/mnt/c/Users/Melek/Downloads" required>
                    <div class="form-text">
                        WSL için örnek: /mnt/c/Users/Melek/Downloads<br>
                        Windows için örnek: C:\Users\Melek\Downloads
                    </div>
                </div>
            </div>

            <!-- Kategoriler ve Alt Kategoriler -->
            <div class="row mb-3">
                <div class="col-12">
                    <label class="form-label">Tarama Kategorileri</label>
                    <div class="select-all-container">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllCategories">
                            <label class="form-check-label" for="selectAllCategories">Tüm Kategorileri Seç</label>
                        </div>
                    </div>

                    <!-- Kişisel Bilgiler -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleSubcategories('personalInfo')">
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" name="categories" value="personalInfo" id="personalInfo">
                                <label class="form-check-label" for="personalInfo">Kişisel Bilgiler</label>
                            </div>
                        </div>
                        <div class="subcategory-container" id="personalInfo-subcategories">
                            <div class="form-check">
                                <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[personalInfo]" value="TC Kimlik Numarası" id="tcKimlik">
                                <label class="form-check-label" for="tcKimlik">TC Kimlik Numarası</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[personalInfo]" value="E-posta Adresi" id="eposta">
                                <label class="form-check-label" for="eposta">E-posta Adresi</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[personalInfo]" value="Telefon Numarası (Mobil)" id="telefonMobil">
                                <label class="form-check-label" for="telefonMobil">Telefon Numarası (Mobil)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[personalInfo]" value="Telefon Numarası (Sabit Hat)" id="telefonSabit">
                                <label class="form-check-label" for="telefonSabit">Telefon Numarası (Sabit Hat)</label>
                            </div>
                        </div>
                    </div>

                    <!-- Finansal Veriler -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleSubcategories('financialData')">
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" name="categories" value="financialData" id="financialData">
                                <label class="form-check-label" for="financialData">Finansal Veriler</label>
                            </div>
                        </div>
                        <div class="subcategory-container" id="financialData-subcategories">
                            <div class="form-check">
                                <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[financialData]" value="Kredi Kartı Numarası" id="krediKarti">
                                <label class="form-check-label" for="krediKarti">Kredi Kartı Numarası</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[financialData]" value="IBAN" id="iban">
                                <label class="form-check-label" for="iban">IBAN</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[financialData]" value="Hesap Numarası" id="hesapNo">
                                <label class="form-check-label" for="hesapNo">Hesap Numarası</label>
                            </div>
                        </div>
                    </div>

                    <!-- Sağlık Verileri -->
                    <div class="category-container">
                        <div class="category-header" onclick="toggleSubcategories('healthData')">
                            <div class="form-check">
                                <input class="form-check-input category-checkbox" type="checkbox" name="categories" value="healthData" id="healthData">
                                <label class="form-check-label" for="healthData">Sağlık Verileri</label>
                            </div>
                        </div>
                        <div class="subcategory-container" id="healthData-subcategories">
                            <div class="form-check">
                                <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[healthData]" value="SGK Numarası" id="sgkNo">
                                <label class="form-check-label" for="sgkNo">SGK Numarası</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[healthData]" value="Hasta Kayıt Numarası" id="hastaNo">
                                <label class="form-check-label" for="hastaNo">Hasta Kayıt Numarası</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dosya Türleri -->
            <div class="row mb-3">
                <div class="col-12">
                    <label class="form-label">Dosya Türleri</label>
                    <div class="mb-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllFileTypes">
                            <i class="bi bi-check-all"></i> Tümünü Seç
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAllFileTypes">
                            <i class="bi bi-x-lg"></i> Tümünü Temizle
                        </button>
                    </div>
                    <div class="file-types-container">
                        <div class="file-type-group">
                            <h6><i class="bi bi-file-text"></i> Metin Dosyaları</h6>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="txt" id="txt" checked>
                                <label class="form-check-label file-type-label" for="txt">.txt</label>
                                <div class="file-type-description">Düz metin dosyaları</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="md" id="md">
                                <label class="form-check-label file-type-label" for="md">.md</label>
                                <div class="file-type-description">Markdown belgeleri</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="log" id="log">
                                <label class="form-check-label file-type-label" for="log">.log</label>
                                <div class="file-type-description">Log dosyaları</div>
                            </div>
                        </div>

                        <div class="file-type-group">
                            <h6><i class="bi bi-table"></i> Tablolar & Veri</h6>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="csv" id="csv" checked>
                                <label class="form-check-label file-type-label" for="csv">.csv</label>
                                <div class="file-type-description">Virgülle ayrılmış değerler</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="tsv" id="tsv">
                                <label class="form-check-label file-type-label" for="tsv">.tsv</label>
                                <div class="file-type-description">Sekmeyle ayrılmış değerler</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="json" id="json" checked>
                                <label class="form-check-label file-type-label" for="json">.json</label>
                                <div class="file-type-description">JSON veri dosyaları</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="xml" id="xml">
                                <label class="form-check-label file-type-label" for="xml">.xml</label>
                                <div class="file-type-description">XML belgeleri</div>
                            </div>
                        </div>

                        <div class="file-type-group">
                            <h6><i class="bi bi-file-earmark-text"></i> Ofis & Doküman</h6>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="docx" id="docx" {% if DOCX_AVAILABLE %}checked{% else %}disabled{% endif %}>
                                <label class="form-check-label file-type-label" for="docx">.docx</label>
                                <div class="file-type-description">Microsoft Word belgeleri {% if not DOCX_AVAILABLE %}(Eksik bağımlılık){% endif %}</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="pdf" id="pdf" {% if PDF_AVAILABLE %}checked{% else %}disabled{% endif %}>
                                <label class="form-check-label file-type-label" for="pdf">.pdf</label>
                                <div class="file-type-description">PDF belgeleri {% if not PDF_AVAILABLE %}(Eksik bağımlılık){% endif %}</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="pptx" id="pptx" {% if PPTX_AVAILABLE %}checked{% else %}disabled{% endif %}>
                                <label class="form-check-label file-type-label" for="pptx">.pptx</label>
                                <div class="file-type-description">Microsoft PowerPoint sunumları {% if not PPTX_AVAILABLE %}(Eksik bağımlılık){% endif %}</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="xlsx" id="xlsx">
                                <label class="form-check-label file-type-label" for="xlsx">.xlsx</label>
                                <div class="file-type-description">Microsoft Excel çalışma kitapları</div>
                            </div>
                        </div>

                        <div class="file-type-group">
                            <h6><i class="bi bi-code"></i> Kod Dosyaları</h6>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="py" id="py">
                                <label class="form-check-label file-type-label" for="py">.py</label>
                                <div class="file-type-description">Python kaynak kodları</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="js" id="js">
                                <label class="form-check-label file-type-label" for="js">.js</label>
                                <div class="file-type-description">JavaScript dosyaları</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="html" id="html">
                                <label class="form-check-label file-type-label" for="html">.html</label>
                                <div class="file-type-description">HTML dosyaları</div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="css" id="css">
                                <label class="form-check-label file-type-label" for="css">.css</label>
                                <div class="file-type-description">CSS dosyaları</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg mt-3"><i class="bi bi-play-circle"></i> Taramayı Başlat</button>
        </form>

        {% if error_message %}
            <div class="alert alert-danger mt-4" role="alert">
                {{ error_message }}
            </div>
        {% endif %}
    </div>

    {% if results or processed_files_count is not None %}
    <div class="result-section">
        <h3 class="mb-3">Tarama Sonuçları</h3>
        <p>Tarama Süresi: {{ scan_duration }} saniye</p>
        <p>İşlenen Dosya Sayısı: {{ processed_files_count }}</p>
        <p>Eşleşme Bulunan Dosya Sayısı: {{ matched_files_count }}</p>

        {% if skipped_files %}
            <div class="alert alert-warning mt-3">
                <h5>Atlanan Dosyalar ({{ skipped_files|length }})</h5>
                <ul>
                    {% for skipped_file in skipped_files %}
                        <li>{{ skipped_file.file }} (Neden: {{ skipped_file.reason }})</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if error_files %}
            <div class="alert alert-danger mt-3">
                <h5>Hata Alan Dosyalar ({{ error_files|length }})</h5>
                <ul>
                    {% for error_file in error_files %}
                        <li>{{ error_file.path }} (Hata: {{ error_file.error }})</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if results %}
            <h4 class="mt-4">Eşleşmeler</h4>
            {% for file_result in results %}
                <div class="card file-result-card">
                    <div class="card-header">
                        Dosya: <a href="{% url 'regex:sensitive_scan_detail' file_result.encoded_file_path %}" class="text-white">{{ file_result.file_path }}</a>
                    </div>
                    <div class="card-body">
                        {% for category, subcategories in file_result.matches.items %}
                            <h5>{{ category }}</h5>
                            {% for subcategory, matches in subcategories.items %}
                                <h6>{{ subcategory }}</h6>
                                <ul>
                                    {% for match_item in matches %}
                                        <div class="match-item">
                                            <p>Eşleşme: <strong>{{ match_item.match }}</strong></p>
                                            <div class="match-details">
                                                <p>Satır Numarası: {{ match_item.line_number }}</p>
                                                <p>Satır İçeriği: <pre>{{ match_item.line_content }}</pre></p>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </ul>
                            {% endfor %}
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            {% if processed_files_count is not None and matched_files_count == 0 and not error_files and not skipped_files %}
                <div class="alert alert-info mt-4" role="alert">
                    Belirtilen kriterlere göre hiçbir eşleşme bulunamadı.
                </div>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // JavaScript for toggling subcategories
    function toggleSubcategories(categoryId) {
        var subcategoryContainer = document.getElementById(categoryId + '-subcategories');
        if (subcategoryContainer) {
            subcategoryContainer.classList.toggle('show');
        }
    }

    // JavaScript for "Select All Categories" checkbox
    document.getElementById('selectAllCategories').addEventListener('change', function() {
        var categoryCheckboxes = document.querySelectorAll('.category-checkbox');
        var subcategoryCheckboxes = document.querySelectorAll('.subcategory-checkbox');
        var isChecked = this.checked;

        categoryCheckboxes.forEach(function(checkbox) {
            checkbox.checked = isChecked;
            // Optionally toggle subcategory visibility
            var subcategoryId = checkbox.id + '-subcategories';
            var subcategoryContainer = document.getElementById(subcategoryId);
            if (subcategoryContainer) {
                if (isChecked) {
                    subcategoryContainer.classList.add('show');
                } else {
                    subcategoryContainer.classList.remove('show');
                }
            }
        });
        subcategoryCheckboxes.forEach(function(checkbox) {
            checkbox.checked = isChecked;
        });
    });

    // JavaScript for category checkboxes to check/uncheck their subcategories
    document.querySelectorAll('.category-checkbox').forEach(function(categoryCheckbox) {
        categoryCheckbox.addEventListener('change', function() {
            var subcategoryId = this.id + '-subcategories';
            var subcategoryCheckboxes = document.querySelectorAll('#' + subcategoryId + ' .subcategory-checkbox');
            var isChecked = this.checked;

            subcategoryCheckboxes.forEach(function(checkbox) {
                checkbox.checked = isChecked;
            });

            // Toggle visibility of subcategory container
            var subcategoryContainer = document.getElementById(subcategoryId);
            if (subcategoryContainer) {
                if (isChecked) {
                    subcategoryContainer.classList.add('show');
                } else {
                    subcategoryContainer.classList.remove('show');
                }
            }
        });
    });

    // JavaScript for subcategory checkboxes to check/uncheck their parent category
    document.querySelectorAll('.subcategory-checkbox').forEach(function(subcategoryCheckbox) {
        subcategoryCheckbox.addEventListener('change', function() {
            var parentCategoryContainer = this.closest('.subcategory-container');
            if (parentCategoryContainer) {
                var categoryId = parentCategoryContainer.id.replace('-subcategories', '');
                var categoryCheckbox = document.getElementById(categoryId);
                if (categoryCheckbox) {
                    var allSubcategoriesChecked = true;
                    document.querySelectorAll('#' + parentCategoryContainer.id + ' .subcategory-checkbox').forEach(function(checkbox) {
                        if (!checkbox.checked) {
                            allSubcategoriesChecked = false;
                        }
                    });
                    categoryCheckbox.checked = allSubcategoriesChecked;
                }
            }
        });
    });

    // JavaScript for "Select All File Types" and "Deselect All File Types" buttons
    document.getElementById('selectAllFileTypes').addEventListener('click', function() {
        document.querySelectorAll('.file-type-checkbox').forEach(function(checkbox) {
            checkbox.checked = true;
        });
    });

    document.getElementById('deselectAllFileTypes').addEventListener('click', function() {
        document.querySelectorAll('.file-type-checkbox').forEach(function(checkbox) {
            checkbox.checked = false;
        });
    });

    // Form validation
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }
                    form.classList.add('was-validated')
                }, false)
            })
    })()

    // Preserve selected categories and file types after submission if there's an error message
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const selectedCategoriesParam = urlParams.get('selected_categories');
        const selectedFileTypesParam = urlParams.get('selected_file_types');
        const directoryPathParam = urlParams.get('directory_path');

        if (directoryPathParam) {
            document.getElementById('directory').value = decodeURIComponent(directoryPathParam);
        }

        if (selectedCategoriesParam) {
            const selectedCategories = selectedCategoriesParam.split(',');
            selectedCategories.forEach(categoryId => {
                const checkbox = document.getElementById(categoryId);
                if (checkbox) {
                    checkbox.checked = true;
                    // Also ensure parent category header is opened
                    const subcategoryContainer = document.getElementById(categoryId + '-subcategories');
                    if (subcategoryContainer) {
                        subcategoryContainer.classList.add('show');
                    }
                }
            });
        }
        
        if (selectedFileTypesParam) {
            const selectedFileTypes = selectedFileTypesParam.split(',');
            selectedFileTypes.forEach(fileType => {
                const checkbox = document.getElementById(fileType);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
    });

    // Handle initial state for subcategories based on pre-selected categories
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.category-checkbox').forEach(function(categoryCheckbox) {
            if (categoryCheckbox.checked) {
                var subcategoryId = categoryCheckbox.id + '-subcategories';
                var subcategoryContainer = document.getElementById(subcategoryId);
                if (subcategoryContainer) {
                    subcategoryContainer.classList.add('show');
                }
            }
        });
    });

    // Dynamic pattern loading for front-end (for future use/display)
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/regex/api/patterns/')
            .then(response => response.json())
            .then(data => {
                const patternData = data.patterns;
                // You can use this patternData to dynamically populate frontend display
                // For example, to show descriptions on hover or in a modal
                // Or to create a more dynamic category/subcategory selection based on actual patterns
                console.log("Loaded patterns:", patternData);
            })
            .catch(error => console.error('Error loading patterns:', error));
    });
</script>
{% endblock %} 