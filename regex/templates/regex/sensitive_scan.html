{% extends 'list/base.html' %}
{% load static %}

{% block title %}Hassas Veri Taraması Başlat{% endblock %}

{% block extra_css %}
<style>
    .scan-container {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .category-container {
        margin-bottom: 15px;
        padding: 10px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        background-color: white;
    }
    .category-header {
        cursor: pointer;
        padding: 10px;
        background-color: #e9ecef;
        border-radius: 3px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .category-header:hover {
        background-color: #dee2e6;
    }
    .category-title {
        font-weight: 500;
        margin: 0;
    }
    .category-description {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
    }
    .subcategory-container {
        margin-left: 20px;
        display: none;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    .subcategory-container.show {
        display: block;
    }
    .subcategory-item {
        margin-bottom: 10px;
        padding: 8px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background-color: white;
    }
    .subcategory-item:hover {
        background-color: #f8f9fa;
    }
    .subcategory-description {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 3px;
        margin-left: 25px;
    }
    .file-types-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
    }
    .select-all-container {
        margin-bottom: 10px;
    }
    .file-type-group {
        background-color: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    .file-type-group:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    .file-type-group h6 {
        color: #495057;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid #e9ecef;
    }
    .file-type-checkbox {
        cursor: pointer;
    }
    .file-type-label {
        cursor: pointer;
        padding: 5px 10px;
        border-radius: 4px;
        transition: all 0.2s ease;
        display: inline-block;
        width: 100%;
    }
    .file-type-label:hover {
        background-color: #f8f9fa;
    }
    .file-type-checkbox:checked + .file-type-label {
        background-color: #e3f2fd;
        color: #0d6efd;
    }
    .file-type-description {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 2px;
        display: none;
    }
    .file-type-label:hover + .file-type-description {
        display: block;
    }
    .toggle-icon {
        transition: transform 0.3s ease;
    }
    .toggle-icon.rotated {
        transform: rotate(180deg);
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4">
        <i class="bi bi-shield-check"></i> Hassas Veri Taraması Başlat
    </h2>
    <div class="scan-container">
        <form method="post" action="{% url 'regex:sensitive_scan' %}" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="row mb-3">
                <div class="col-md-12">
                    <label for="directory" class="form-label">Arama Yapılacak Dizin</label>
                    <input type="text" class="form-control" id="directory" name="directory" placeholder="/mnt/c/Users/Melek/Downloads" required>
                    <div class="form-text">
                        WSL için örnek: /mnt/c/Users/Melek/Downloads<br>
                        Windows için örnek: C:\Users\Melek\Downloads
                    </div>
                </div>
            </div>

            <!-- Kategoriler ve Alt Kategoriler -->
            <div class="row mb-3">
                <div class="col-12">
                    <label class="form-label">Tarama Kategorileri</label>
                    <div class="select-all-container">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="selectAllCategories">
                            <label class="form-check-label" for="selectAllCategories">Tüm Kategorileri Seç</label>
                        </div>
                    </div>

                    {% for category, data in categories.items %}
                    <div class="category-container">
                        <div class="category-header" onclick="toggleSubcategories('{{ category }}')">
                            <div>
                                <div class="form-check">
                                    <input class="form-check-input category-checkbox" type="checkbox" name="categories" value="{{ category }}" id="{{ category }}">
                                    <label class="form-check-label category-title" for="{{ category }}">{{ data.name }}</label>
                                </div>
                                <div class="category-description">{{ data.description }}</div>
                            </div>
                            <i class="bi bi-chevron-down toggle-icon" id="{{ category }}-icon"></i>
                        </div>
                        <div class="subcategory-container" id="{{ category }}-subcategories">
                            {% for subcategory, subdata in data.subcategories.items %}
                            <div class="subcategory-item">
                                <div class="form-check">
                                    <input class="form-check-input subcategory-checkbox" type="checkbox" name="subcategories[{{ category }}]" value="{{ subcategory }}" id="{{ category }}_{{ subcategory }}">
                                    <label class="form-check-label" for="{{ category }}_{{ subcategory }}">{{ subdata.name }}</label>
                                </div>
                                <div class="subcategory-description">{{ subdata.description }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Dosya Türleri -->
            <div class="row mb-3">
                <div class="col-12">
                    <label class="form-label">Dosya Türleri</label>
                    <div class="mb-2">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllFileTypes">
                            <i class="bi bi-check-all"></i> Tümünü Seç
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAllFileTypes">
                            <i class="bi bi-x-lg"></i> Tümünü Temizle
                        </button>
                    </div>
                    <div class="file-types-container">
                        {% for group_name, extensions in file_types.items %}
                        <div class="file-type-group">
                            <h6>
                                {% if group_name == 'text' %}
                                <i class="bi bi-file-text"></i> Metin Dosyaları
                                {% elif group_name == 'office' %}
                                <i class="bi bi-file-earmark-text"></i> Ofis & Doküman
                                {% elif group_name == 'data' %}
                                <i class="bi bi-table"></i> Tablolar & Veri
                                {% elif group_name == 'web' %}
                                <i class="bi bi-globe"></i> Web Dosyaları
                                {% elif group_name == 'archive' %}
                                <i class="bi bi-file-earmark-zip"></i> Arşiv Dosyaları
                                {% elif group_name == 'image' %}
                                <i class="bi bi-file-earmark-image"></i> Görsel Dosyalar
                                {% endif %}
                            </h6>
                            {% for ext in extensions %}
                            <div class="form-check">
                                <input class="form-check-input file-type-checkbox" type="checkbox" name="file_types" value="{{ ext }}" id="{{ ext }}" {% if ext in 'txt,docx,pdf,csv,json' %}checked{% endif %}>
                                <label class="form-check-label file-type-label" for="{{ ext }}">.{{ ext }}</label>
                                <div class="file-type-description">
                                    {% if ext == 'txt' %}
                                    Düz metin dosyaları
                                    {% elif ext == 'md' %}
                                    Markdown belgeleri
                                    {% elif ext == 'log' %}
                                    Log dosyaları
                                    {% elif ext == 'docx' %}
                                    Word belgeleri
                                    {% elif ext == 'pdf' %}
                                    PDF belgeleri
                                    {% elif ext == 'xlsx' %}
                                    Excel tabloları
                                    {% elif ext == 'csv' %}
                                    Virgülle ayrılmış değerler
                                    {% elif ext == 'json' %}
                                    JSON veri dosyaları
                                    {% elif ext == 'xml' %}
                                    XML belgeleri
                                    {% elif ext == 'zip' %}
                                    ZIP arşivleri
                                    {% elif ext == 'rar' %}
                                    RAR arşivleri
                                    {% elif ext == 'png' %}
                                    PNG görselleri
                                    {% elif ext == 'jpg' %}
                                    JPEG görselleri
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Taramayı Başlat
                </button>
            </div>
        </form>
    </div>
    {% if error_message %}
    <div class="alert alert-danger mt-3">{{ error_message }}</div>
    {% endif %}

    {% if results %}
    <div class="alert alert-info mt-4">
        <strong>Sonuçlar:</strong>
        <ul>
        {% for result in results %}
            <li>
                <strong>{{ result.file_path }}</strong>
                <ul>
                {% for category, subcats in result.matches.items %}
                    <li>{{ category }}
                        <ul>
                        {% for subcat, matches in subcats.items %}
                            <li>{{ subcat }}: {{ matches|join:", " }}</li>
                        {% endfor %}
                        </ul>
                    </li>
                {% endfor %}
                </ul>
            </li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if error_files %}
    <div class="alert alert-warning mt-4">
        <strong>Erişilemeyen/Hatalı Dosyalar:</strong>
        <ul>
        {% for file in error_files %}
            <li>{{ file }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if skipped_files %}
    <div class="alert alert-secondary mt-4">
        <strong>Atlanan Dosyalar:</strong>
        <ul>
        {% for file in skipped_files %}
            <li>{{ file }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Form doğrulama
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })();

    // Alt kategorileri göster/gizle
    function toggleSubcategories(categoryId) {
        const subcategories = document.getElementById(`${categoryId}-subcategories`);
        const icon = document.getElementById(`${categoryId}-icon`);
        subcategories.classList.toggle('show');
        icon.classList.toggle('rotated');
    }

    // Kategori checkbox'ı değiştiğinde
    document.querySelectorAll('.category-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const categoryId = this.id;
            const subcategories = document.querySelectorAll(`#${categoryId}-subcategories .subcategory-checkbox`);
            subcategories.forEach(sub => {
                sub.checked = this.checked;
            });
        });
    });

    // Alt kategori checkbox'ı değiştiğinde
    document.querySelectorAll('.subcategory-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const categoryId = this.name.match(/\[(.*?)\]/)[1];
            const categoryCheckbox = document.getElementById(categoryId);
            const subcategories = document.querySelectorAll(`#${categoryId}-subcategories .subcategory-checkbox`);
            const allChecked = Array.from(subcategories).every(sub => sub.checked);
            categoryCheckbox.checked = allChecked;
        });
    });

    // Tüm kategorileri seç/kaldır
    document.getElementById('selectAllCategories').addEventListener('change', function() {
        const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
        const subcategoryCheckboxes = document.querySelectorAll('.subcategory-checkbox');
        
        categoryCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        
        subcategoryCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // Geçmiş dizinler için otomatik tamamlama
    document.addEventListener('DOMContentLoaded', function() {
        const dirInput = document.getElementById('directory');
        let history = JSON.parse(localStorage.getItem('directoryHistory') || '[]');
        dirInput.addEventListener('focus', function() {
            if (history.length > 0) {
                let datalist = document.getElementById('dirHistoryList');
                if (!datalist) {
                    datalist = document.createElement('datalist');
                    datalist.id = 'dirHistoryList';
                    document.body.appendChild(datalist);
                    dirInput.setAttribute('list', 'dirHistoryList');
                }
                datalist.innerHTML = '';
                history.forEach(function(item) {
                    let option = document.createElement('option');
                    option.value = item;
                    datalist.appendChild(option);
                });
            }
        });
        document.querySelector('form').addEventListener('submit', function() {
            const val = dirInput.value.trim();
            if (val && !history.includes(val)) {
                history.push(val);
                localStorage.setItem('directoryHistory', JSON.stringify(history));
            }
        });
    });

    // Dosya türü tümünü seç/temizle
    document.getElementById('selectAllFileTypes').onclick = function() {
        document.querySelectorAll('.file-type-checkbox').forEach(cb => cb.checked = true);
    };
    document.getElementById('deselectAllFileTypes').onclick = function() {
        document.querySelectorAll('.file-type-checkbox').forEach(cb => cb.checked = false);
    };

    // Dosya tipi seçimleri için hover efekti
    document.querySelectorAll('.file-type-label').forEach(label => {
        label.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
            this.nextElementSibling.style.display = 'block';
        });
        
        label.addEventListener('mouseleave', function() {
            if (!this.previousElementSibling.checked) {
                this.style.backgroundColor = '';
            }
            this.nextElementSibling.style.display = 'none';
        });
    });

    // Seçili dosya tiplerini vurgula
    document.querySelectorAll('.file-type-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const label = this.nextElementSibling;
            if (this.checked) {
                label.style.backgroundColor = '#e3f2fd';
                label.style.color = '#0d6efd';
            } else {
                label.style.backgroundColor = '';
                label.style.color = '';
            }
        });
    });
</script>
{% endblock %} 