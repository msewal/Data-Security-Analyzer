{% extends 'list/base.html' %}
{% load static %}

{% block title %}Dosya Görüntüleyici - {{ file_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Ana Sayfa</a></li>
            <li class="breadcrumb-item"><a href="{% url 'regex_search' %}">Regex Arama</a></li>
            <li class="breadcrumb-item"><a href="{% url 'regex_search_results' %}">Sonuçlar</a></li>
            <li class="breadcrumb-item active">{{ file_name }}</li>
        </ol>
    </nav>

    {% if error_message %}
    <div class="card mb-4">
        <div class="card-header bg-danger text-white">
            <h5 class="card-title mb-0">
                <i class="bi bi-exclamation-triangle"></i> Hata
            </h5>
        </div>
        <div class="card-body">
            <div class="alert alert-danger">
                {{ error_message }}
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>Dosya Yolu:</strong> {{ file_path }}
                </div>
                {% if file_type %}
                <div class="col-md-3">
                    <strong>Dosya Türü:</strong> {{ file_type|upper }}
                </div>
                {% endif %}
                {% if file_size %}
                <div class="col-md-3">
                    <strong>Dosya Boyutu:</strong> {{ file_size|filesizeformat }}
                </div>
                {% endif %}
            </div>
            <a href="{% url 'regex_search_results' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Geri Dön
            </a>
        </div>
    </div>
    {% else %}
    <div class="card mb-4">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-earmark"></i> {{ file_name }}
                    </h5>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{% url 'regex_search_results' %}" class="btn btn-secondary">
                        <i class="bi bi-arrow-left"></i> Geri Dön
                    </a>
                    <a href="{% url 'regex:edit_file' file_path %}" class="btn btn-warning">
                        <i class="bi bi-pencil"></i> Düzenle
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <strong>Dosya Yolu:</strong> {{ file_path }}
                </div>
                <div class="col-md-3">
                    <strong>Dosya Türü:</strong> {{ file_type|upper }}
                </div>
                <div class="col-md-3">
                    <strong>Dosya Boyutu:</strong> {{ file_size|filesizeformat }}
                </div>
            </div>
            
            {% if pattern %}
            <div class="row mb-3">
                <div class="col-md-8">
                    <strong>Arama Pattern'i:</strong> <code>{{ pattern }}</code>
                </div>
                <div class="col-md-4">
                    <strong>Eşleşme Sayısı:</strong> 
                    <span class="badge badge-primary">{{ matches_count }}</span>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    {% if is_viewable %}
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Dosya İçeriği</h6>
                    <div>
                        {% if matches_count > 0 %}
                            <span class="badge badge-warning">
                                {{ matches_count }} eşleşme üstü çizili olarak işaretlenmiştir
                            </span>
                        {% endif %}
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleWrap()">
                            <i class="bi bi-text-wrap"></i> Satır Kaydırma
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyContent()">
                            <i class="bi bi-clipboard"></i> Kopyala
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                {% if is_text_file %}
                    <pre id="fileContent" class="m-0 p-3" style="max-height: 600px; overflow-y: auto; background-color: #f8f9fa; white-space: pre-wrap;">{{ content|safe }}</pre>
                {% elif is_office_file %}
                    <div class="p-3">
                        {% if file_type == 'pdf' %}
                            <div class="alert alert-info">
                                <i class="bi bi-file-pdf"></i> Bu bir PDF dosyasıdır. İçerik metne dönüştürülerek gösterilmektedir.
                            </div>
                        {% elif file_type in 'docx,doc' %}
                            <div class="alert alert-info">
                                <i class="bi bi-file-word"></i> Bu bir Word dosyasıdır. İçerik metne dönüştürülerek gösterilmektedir.
                            </div>
                        {% elif file_type in 'pptx,ppt' %}
                            <div class="alert alert-info">
                                <i class="bi bi-file-ppt"></i> Bu bir PowerPoint dosyasıdır. İçerik metne dönüştürülerek gösterilmektedir.
                            </div>
                        {% endif %}
                        <pre id="fileContent" class="m-0 p-3" style="max-height: 600px; overflow-y: auto; background-color: #f8f9fa; white-space: pre-wrap;">{{ content|safe }}</pre>
                    </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-body text-center">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    Bu dosya türü ({{ file_type|upper }}) görüntüleme için desteklenmiyor.
                    <br>
                    Desteklenen türler: TXT, HTML, CSS, JS, JSON, XML, YAML, MD, LOG, PDF, DOCX, PPTX
                </div>
                <a href="{% url 'regex:edit_file' file_path %}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> Dosyayı Düzenle
                </a>
            </div>
        </div>
    {% endif %}
</div>

<script>
function toggleWrap() {
    const content = document.getElementById('fileContent');
    const currentWrap = content.style.whiteSpace;
    
    if (currentWrap === 'nowrap') {
        content.style.whiteSpace = 'pre-wrap';
        content.style.overflowX = 'visible';
    } else {
        content.style.whiteSpace = 'nowrap';
        content.style.overflowX = 'auto';
    }
}

function copyContent() {
    const content = document.getElementById('fileContent');
    const text = content.textContent || content.innerText;
    
    navigator.clipboard.writeText(text).then(function() {
        // Geçici başarı mesajı göster
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i> Kopyalandı!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-secondary');
        
        setTimeout(function() {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(function(err) {
        alert('Kopyalama başarısız: ' + err);
    });
}

// Dosya içeriğini vurgula
document.addEventListener('DOMContentLoaded', function() {
    // Eğer eşleşmeler varsa, sayfa yüklendiğinde ilk eşleşmeye scroll yap
    const firstMatch = document.querySelector('mark');
    if (firstMatch) {
        firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
});
</script>

<style>
mark {
    animation: highlight 2s ease-in-out;
}

@keyframes highlight {
    0% { background-color: #ff6b6b; }
    50% { background-color: #ffeb3b; }
    100% { background-color: #ffeb3b; }
}

pre {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.4;
}

.card-body pre {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
}
</style>
{% endblock %} 