{% extends 'list/base.html' %}
{% load static %}

{% block title %}Regex Arama Sonuçları{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Ana Sayfa</a></li>
            <li class="breadcrumb-item"><a href="{% url 'regex_search' %}">Regex Arama</a></li>
            <li class="breadcrumb-item active">Sonuçlar</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">İşlenen Dosyalar</h5>
                    <p class="card-text display-4">{{ results.matches|length|add:results.errors|length|add:results.skipped|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Eşleşen Dosyalar</h5>
                    <p class="card-text display-4">{{ results.matches|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <h5 class="card-title">Hata Dosyaları</h5>
                    <p class="card-text display-4">{{ results.errors|length }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Atlanan Dosyalar</h5>
                    <p class="card-text display-4">{{ results.skipped|length }}</p>
                </div>
            </div>
        </div>
    </div>

<div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Filtreler</h5>
        </div>
    <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="fileFilter">Dosya Adı</label>
                        <input type="text" class="form-control" id="fileFilter" placeholder="Dosya adına göre filtrele...">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="patternFilter">Pattern</label>
                        <input type="text" class="form-control" id="patternFilter" placeholder="Pattern'e göre filtrele...">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="matchFilter">Eşleşme</label>
                        <input type="text" class="form-control" id="matchFilter" placeholder="Eşleşmeye göre filtrele...">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="resultTypeFilter">Sonuç Türü</label>
                        <select class="form-control" id="resultTypeFilter">
                            <option value="all">Tümü</option>
                            <option value="matches">Eşleşmeler</option>
                            <option value="errors">Hatalar</option>
                            <option value="skipped">Atlananlar</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="matches-tab" data-toggle="tab" href="#matches" role="tab">
                        Eşleşmeler ({{ results.matches|length }})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="errors-tab" data-toggle="tab" href="#errors" role="tab">
                        Hatalar ({{ results.errors|length }})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="skipped-tab" data-toggle="tab" href="#skipped" role="tab">
                        Atlananlar ({{ results.skipped|length }})
                    </a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <div class="tab-pane fade show active" id="matches" role="tabpanel">
                    {% if results.matches %}
            <div class="table-responsive">
                        <table class="table table-hover">
                    <thead>
                        <tr>
                                    <th>Dosya</th>
                                    <th>Eşleşme Sayısı</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                                {% for match in results.matches %}
                        <tr>
                                    <td>{{ match.path }}</td>
                                    <td>{{ match.matches|length }}</td>
                            <td>
                                        <a href="{% url 'regex_search_detail' match.path %}" class="btn btn-sm btn-info">
                                            <i class="bi bi-eye"></i> Detay
                                    </a>
                                        <a href="{% url 'regex:view_file' match.path %}" class="btn btn-sm btn-info">
                                            <i class="bi bi-eye"></i> Görüntüle
                                        </a>
                                        <button class="btn btn-sm btn-warning edit-file" data-file="{{ match.path }}">
                                            <i class="bi bi-pencil"></i> Düzenle
                                        </button>
                                        <button class="btn btn-sm btn-danger quarantine-file" data-file="{{ match.path }}">
                                            <i class="bi bi-shield-lock"></i> Karantina
                                    </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
                    {% else %}
                    <div class="alert alert-info">
                        Eşleşen dosya bulunamadı.
    </div>
    {% endif %}
        </div>

                <div class="tab-pane fade" id="errors" role="tabpanel">
                    {% if results.errors %}
            <div class="table-responsive">
                        <table class="table table-hover">
                    <thead>
                        <tr>
                                    <th>Dosya</th>
                            <th>Hata</th>
                        </tr>
                    </thead>
                    <tbody>
                                {% for error in results.errors %}
                        <tr>
                                    <td>{{ error.path }}</td>
                                    <td>{{ error.error }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
                    {% else %}
                    <div class="alert alert-info">
                        Hata dosyası bulunamadı.
        </div>
                    {% endif %}
                </div>

                <div class="tab-pane fade" id="skipped" role="tabpanel">
                    {% if results.skipped %}
            <div class="table-responsive">
                        <table class="table table-hover">
                    <thead>
                        <tr>
                                    <th>Dosya</th>
                            <th>Neden</th>
                        </tr>
                    </thead>
                    <tbody>
                                {% for skip in results.skipped %}
                        <tr>
                                    <td>{{ skip.path }}</td>
                                    <td>{{ skip.reason }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                </table>
                </div>
                    {% else %}
                    <div class="alert alert-info">
                        Atlanan dosya bulunamadı.
                    </div>
                    {% endif %}
              </div>
            </div>
        </div>
    </div>
                                    </div>

<!-- Dosya Düzenleme Modal -->
<div class="modal fade" id="editFileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dosya Düzenle</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
                            </div>
            <div class="modal-body">
                <form id="editFileForm">
                    <input type="hidden" id="editFilePath" name="file_path">
                    <div class="form-group">
                        <label for="fileContent">Dosya İçeriği</label>
                        <textarea class="form-control" id="fileContent" name="content" rows="20"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="saveFile">Kaydet</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filtreleme işlemleri
    const fileFilter = document.getElementById('fileFilter');
    const patternFilter = document.getElementById('patternFilter');
    const matchFilter = document.getElementById('matchFilter');
    const resultTypeFilter = document.getElementById('resultTypeFilter');

    function applyFilters() {
        const fileValue = fileFilter.value.toLowerCase();
        const patternValue = patternFilter.value.toLowerCase();
        const matchValue = matchFilter.value.toLowerCase();
        const resultType = resultTypeFilter.value;

        document.querySelectorAll('tbody tr').forEach(function(row) {
            const file = row.querySelector('td:first-child').textContent.toLowerCase();
            const pattern = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
            const match = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
            const type = row.closest('.tab-pane').id;

            const fileMatch = file.includes(fileValue);
            const patternMatch = pattern.includes(patternValue);
            const matchMatch = match.includes(matchValue);
            const typeMatch = resultType === 'all' || type === resultType;

            row.style.display = fileMatch && patternMatch && matchMatch && typeMatch ? '' : 'none';
        });
    }

    fileFilter.addEventListener('input', applyFilters);
    patternFilter.addEventListener('input', applyFilters);
    matchFilter.addEventListener('input', applyFilters);
    resultTypeFilter.addEventListener('change', applyFilters);

    // Dosya düzenleme işlemleri
    const editFileModal = document.getElementById('editFileModal');
    const editFilePath = document.getElementById('editFilePath');
    const fileContent = document.getElementById('fileContent');
    const saveFile = document.getElementById('saveFile');

    document.querySelectorAll('.edit-file').forEach(function(button) {
        button.addEventListener('click', function() {
            const file = this.dataset.file;
            editFilePath.value = file;
            
            // Dosya içeriğini al
            fetch(`/regex/edit_file/${encodeURIComponent(file)}`)
                .then(response => response.json())
                .then(data => {
                    fileContent.value = data.content;
                    $(editFileModal).modal('show');
                })
                .catch(error => {
                    console.error('Dosya içeriği alınamadı:', error);
                    alert('Dosya içeriği alınamadı.');
                });
        });
    });

    saveFile.addEventListener('click', function() {
        const form = document.getElementById('editFileForm');
        const formData = new FormData(form);

        fetch('/regex/edit_file/', {
                    method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $(editFileModal).modal('hide');
                location.reload();
            } else {
                alert(data.error || 'Dosya kaydedilemedi.');
            }
        })
        .catch(error => {
            console.error('Dosya kaydedilemedi:', error);
            alert('Dosya kaydedilemedi.');
        });
    });

    // Karantina işlemleri
    document.querySelectorAll('.quarantine-file').forEach(function(button) {
        button.addEventListener('click', function() {
            if (confirm('Bu dosyayı karantinaya almak istediğinizden emin misiniz?')) {
                const file = this.dataset.file;
                
                fetch('/regex/quarantine_file/', {
                    method: 'POST',
                    body: JSON.stringify({ file: file }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.error || 'Dosya karantinaya alınamadı.');
            }
                })
                .catch(error => {
                    console.error('Dosya karantinaya alınamadı:', error);
                    alert('Dosya karantinaya alınamadı.');
                });
            }
        });
    });
});
</script>
{% endblock %}
