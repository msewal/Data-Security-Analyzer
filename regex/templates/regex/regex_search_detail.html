{% extends 'list/base.html' %}
{% load static %}

{% block title %}Regex Arama Detayı{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Ana Sayfa</a></li>
            <li class="breadcrumb-item"><a href="{% url 'regex_search' %}">Regex Arama</a></li>
            <li class="breadcrumb-item"><a href="{% url 'regex_search_results' %}">Sonuçlar</a></li>
            <li class="breadcrumb-item active">Detay</li>
        </ol>
    </nav>

    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">{{ file_path }}</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Pattern</th>
                            <th>Eşleşme</th>
                            <th>Satır</th>
                            <th>Pozisyon</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in matches %}
                        <tr>
                            <td>{{ match.pattern }}</td>
                            <td>{{ match.match }}</td>
                            <td>{{ match.line }}</td>
                            <td>{{ match.position }}</td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-file" data-file="{{ file_path }}">
                                    <i class="bi bi-pencil"></i> Düzenle
                                </button>
                                <button class="btn btn-sm btn-danger quarantine-file" data-file="{{ file_path }}">
                                    <i class="bi bi-shield-lock"></i> Karantina
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">Dosya İçeriği</h5>
        </div>
        <div class="card-body">
            <pre class="file-content">{{ content }}</pre>
        </div>
    </div>
</div>

<!-- Dosya Düzenleme Modal -->
<div class="modal fade" id="editFileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dosya Düzenle</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editFileForm">
                    <input type="hidden" id="editFilePath" name="file_path">
                    <div class="form-group">
                        <label for="fileContent">Dosya İçeriği</label>
                        <textarea class="form-control" id="fileContent" name="content" rows="20"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" id="saveFile">Kaydet</button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Dosya düzenleme işlemleri
    const editFileModal = document.getElementById('editFileModal');
    const editFilePath = document.getElementById('editFilePath');
    const fileContent = document.getElementById('fileContent');
    const saveFile = document.getElementById('saveFile');

    document.querySelectorAll('.edit-file').forEach(function(button) {
        button.addEventListener('click', function() {
            const file = this.dataset.file;
            editFilePath.value = file;
            
            // Dosya içeriğini al
            fetch(`/regex/edit_file/${encodeURIComponent(file)}`)
                .then(response => response.json())
                .then(data => {
                    fileContent.value = data.content;
                    $(editFileModal).modal('show');
                })
                .catch(error => {
                    console.error('Dosya içeriği alınamadı:', error);
                    alert('Dosya içeriği alınamadı.');
                });
        });
    });

    saveFile.addEventListener('click', function() {
        const form = document.getElementById('editFileForm');
        const formData = new FormData(form);

        fetch('/regex/edit_file/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $(editFileModal).modal('hide');
                location.reload();
            } else {
                alert(data.error || 'Dosya kaydedilemedi.');
            }
        })
        .catch(error => {
            console.error('Dosya kaydedilemedi:', error);
            alert('Dosya kaydedilemedi.');
        });
    });

    // Karantina işlemleri
    document.querySelectorAll('.quarantine-file').forEach(function(button) {
        button.addEventListener('click', function() {
            if (confirm('Bu dosyayı karantinaya almak istediğinizden emin misiniz?')) {
                const file = this.dataset.file;
                
                fetch('/regex/quarantine_file/', {
                    method: 'POST',
                    body: JSON.stringify({ file: file }),
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.error || 'Dosya karantinaya alınamadı.');
                    }
                })
                .catch(error => {
                    console.error('Dosya karantinaya alınamadı:', error);
                    alert('Dosya karantinaya alınamadı.');
                });
            }
        });
    });
});
</script>
{% endblock %}
